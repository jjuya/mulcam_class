package _0705.cookie;

import java.io.IOException;
import java.sql.*;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.commons.codec.digest.DigestUtils;
import org.apache.log4j.Logger;


@WebServlet("/Login")
public class Login extends HttpServlet {
	
	private static Logger logger = Logger.getLogger(Login.class);
	
	private static final long serialVersionUID = 1L;

	private void doProcess(HttpServletRequest request, HttpServletResponse response, String view) throws ServletException, IOException {
		RequestDispatcher dispatcher = 
				request.getRequestDispatcher(view);
		dispatcher.forward(request, response);
	} //end doProcess
	
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		doProcess(request, response, "/WEB-INF/views/_0705/login.jsp");
	} //end goGet
	
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		String user_id = request.getParameter("user_id");
		String user_pw = DigestUtils.sha512Hex(request.getParameter("user_pw"));
		String user_name = null;
		
		logger.info("id : " + user_id);
		logger.info("pw : " + user_pw);
		
		//session 설정 : 일반 자바 객체이기 때문에
		HttpSession session = request.getSession();
		
		Connection cn = null;
		PreparedStatement st = null;
		ResultSet rs = null;
		
		StringBuffer sql = new StringBuffer();
		sql.append(" SELECT user_name");
		sql.append(" FROM   t_mem");
		sql.append(" WHERE  user_id=?");
		sql.append(" and    user_pw=?");
		
		try {
			Class.forName("oracle.jdbc.OracleDriver");
			cn = DriverManager.getConnection(
					"jdbc:oracle:thin:@localhost:1521:xe", 
					"bigdata", 
					"bigdata");
			st = cn.prepareStatement(sql.toString());
			st.setString(1, user_id);
			st.setString(2, user_pw);
			rs = st.executeQuery();
			if (rs.next()) {
				user_name = rs.getString("user_name");
			} 
		} catch(Exception e){
			e.printStackTrace();
		} finally {
			if (rs != null) try {rs.close();} catch(Exception e){}
			if (st != null) try {st.close();} catch(Exception e){}
			if (cn != null) try {cn.close();} catch(Exception e){}
		} //end try-catch-finally
		
		if(user_name != null) {
			//session 저장
			session.setAttribute("user_id", user_id);
			session.setAttribute("user_name", user_name);
			
			//cookie 생성
			String save_id = request.getParameter("save_id");
			Cooker.createCookie("user_id", user_id, save_id != null ? 60 *60*24*30 : 0);
			
			
			logger.info("로그인 성공");
			
			request.setAttribute("msg", "로그인 성공");
			request.setAttribute("url", "Main");
			
			doProcess(request, response, "result.jsp");
		}
		else {
			logger.info("아이디 혹은 비밀번호가 틀립니다.");
			
			request.setAttribute("msg", "아이디 혹은 비밀번호가 틀립니다.");
			request.setAttribute("url", "Login");
			
			doProcess(request, response, "result.jsp");
		} //end if
	} //end doPost
	
} //end class

